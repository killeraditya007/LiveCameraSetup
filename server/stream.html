<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Room Camera - Remote Access</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 1200px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #videoFeed {
            width: 100%;
            height: auto;
            display: block;
            max-height: 600px;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .info-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-panel h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .info-panel p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-stream {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .no-stream h3 {
            margin-bottom: 15px;
            color: #333;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Live Room Camera</h1>
            <p>Remote access to your room from anywhere in the world</p>
        </div>

        <div id="status" class="status offline">
            Stream Offline
        </div>

        <div class="video-container">
            <img id="videoFeed" src="" alt="Live Camera Feed" style="display: none;">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Connecting to stream...</p>
            </div>
            <div id="noStream" class="no-stream" style="display: none;">
                <h3>üìπ No Active Stream</h3>
                <p>Make sure your laptop camera is running and connected to the server.</p>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="startStream()">Start Stream</button>
            <button class="btn btn-secondary" onclick="refreshStream()">Refresh Stream</button>
        </div>

        <div class="info-panel">
            <h3>üì° Stream Information</h3>
            <p><strong>Server Status:</strong> <span id="serverStatus">Checking...</span></p>
            <p><strong>Stream Status:</strong> <span id="streamStatus">Unknown</span></p>
            <p><strong>Last Frame:</strong> <span id="lastFrame">Never</span></p>
            <p><strong>Instructions:</strong> This web app connects to your Hostinger server to display the live feed from your laptop camera. Make sure your laptop is running the camera client and connected to the internet.</p>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let isStreaming = false;
        let streamInterval;
        let statusCheckInterval;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            startStatusMonitoring();
        });

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/stream_server.php/api/status`);
                const data = await response.json();
                
                document.getElementById('serverStatus').textContent = 'Online';
                document.getElementById('serverStatus').style.color = '#28a745';
                
                if (data.stream_active) {
                    document.getElementById('streamStatus').textContent = 'Active';
                    document.getElementById('streamStatus').style.color = '#28a745';
                    
                    if (!isStreaming) {
                        startStream();
                    }
                } else {
                    document.getElementById('streamStatus').textContent = 'Inactive';
                    document.getElementById('streamStatus').style.color = '#dc3545';
                    stopStream();
                }
                
                updateLastFrame(data.last_frame_time);
            } catch (error) {
                document.getElementById('serverStatus').textContent = 'Offline';
                document.getElementById('serverStatus').style.color = '#dc3545';
                document.getElementById('streamStatus').textContent = 'Unknown';
                document.getElementById('streamStatus').style.color = '#dc3545';
                updateStatus('offline', 'Server Offline');
            }
        }

        function startStatusMonitoring() {
            statusCheckInterval = setInterval(() => {
                checkServerStatus();
            }, 3000); // Check every 3 seconds
        }

        function updateLastFrame(timestamp) {
            if (timestamp) {
                const date = new Date(timestamp * 1000);
                document.getElementById('lastFrame').textContent = date.toLocaleTimeString();
            } else {
                document.getElementById('lastFrame').textContent = 'Never';
            }
        }

        function updateStatus(status, message) {
            const statusElement = document.getElementById('status');
            statusElement.className = `status ${status}`;
            statusElement.textContent = message;
        }

        async function startStream() {
            try {
                updateStatus('connecting', 'Connecting to Stream...');
                document.getElementById('loading').style.display = 'block';
                document.getElementById('videoFeed').style.display = 'none';
                document.getElementById('noStream').style.display = 'none';

                // Start fetching frames
                streamInterval = setInterval(fetchFrame, 100); // 10 FPS for web display
                isStreaming = true;
                updateStatus('online', 'Live Stream Active');
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                updateStatus('offline', 'Error Starting Stream');
                document.getElementById('loading').style.display = 'none';
            }
        }

        function stopStream() {
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
            }
            isStreaming = false;
            document.getElementById('videoFeed').style.display = 'none';
            document.getElementById('noStream').style.display = 'block';
            updateStatus('offline', 'Stream Offline');
        }

        async function fetchFrame() {
            try {
                const response = await fetch(`${API_BASE}/stream_server.php/api/get_frame`);
                const data = await response.json();
                
                if (data.status === 'success' && data.frame) {
                    const videoFeed = document.getElementById('videoFeed');
                    videoFeed.src = `data:image/jpeg;base64,${data.frame}`;
                    videoFeed.style.display = 'block';
                    document.getElementById('noStream').style.display = 'none';
                    updateLastFrame(data.timestamp);
                } else {
                    // No active stream
                    if (isStreaming) {
                        stopStream();
                    }
                }
            } catch (error) {
                console.error('Error fetching frame:', error);
                if (isStreaming) {
                    stopStream();
                }
            }
        }

        function refreshStream() {
            if (isStreaming) {
                stopStream();
                setTimeout(() => {
                    startStream();
                }, 1000);
            } else {
                startStream();
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (streamInterval) {
                clearInterval(streamInterval);
            }
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        });
    </script>
</body>
</html>
